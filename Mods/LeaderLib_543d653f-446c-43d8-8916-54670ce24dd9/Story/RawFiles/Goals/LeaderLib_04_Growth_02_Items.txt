Version 1
SubGoalCombiner SGC_AND
INITSECTION
//DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, _MatchType, _MatchValue)
KBSECTION
//REGION REGISTERING
PROC
LeaderLib_Growth_Items_Register_DeltaMod((STRING)_ID, (INTEGER)_MinLevel, (STRING)_DeltaMod, (STRING)_MatchType, (STRING)_MatchValue)
THEN
DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, _MatchType, _MatchValue);

PROC
LeaderLib_Growth_Items_Register_Template((STRING)_ID, (STRING)_Template)
THEN
DB_LeaderLib_Growth_Items_TemplateID(_ID, _Template);
//END_REGION

//REGION CLEARING
PROC
LeaderLib_Growth_Items_Clear_ByEntriesID((STRING)_ID)
AND
DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, _MatchType, _MatchValue)
THEN
NOT DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, _MatchType, _MatchValue);

PROC
LeaderLib_Growth_Items_Clear_Template((STRING)_ID)
AND
DB_LeaderLib_Growth_Items_TemplateID(_ID, _Template)
THEN
NOT DB_LeaderLib_Growth_Items_TemplateID(_ID, _Template);
//END_REGION

//REGION ITEM_AUTO_LEVEL
QRY
LeaderLib_Growth_Items_QRY_HasAutoLevelItem((CHARACTERGUID)_Character)
AND
NOT DB_LeaderLib_Growth_Items_Temp_FoundItem(_Character)
AND
CharacterFindTaggedItem(_Character, "LeaderLib_AutoLevel", _Item)
THEN
LeaderLog_Log("TRACE", "[LeaderLib:Growth:Items:HasAutoLevelItem(CharacterFindTaggedItem)] Found tagged item.");
DB_LeaderLib_Growth_Items_Temp_FoundItem(_Character);

//Equipment doesn't return with `CharacterFindTaggedItem`
QRY
LeaderLib_Growth_Items_QRY_HasAutoLevelItem((CHARACTERGUID)_Character)
AND
NOT DB_LeaderLib_Growth_Items_Temp_FoundItem(_Character)
AND
DB_LeaderLib_EquipmentSlots(_Slot)
AND
NOT DB_LeaderLib_Growth_Items_Temp_FoundItem(_Character)
AND
CharacterGetEquippedItem(_Character, _Slot, _Item)
AND
IsTagged(_Item, "LeaderLib_AutoLevel", 1)
THEN
LeaderLog_Log("TRACE", "[LeaderLib:Growth:Items:HasAutoLevelItem] Found tagged equipment in slot [",_Slot,"].");
DB_LeaderLib_Growth_Items_Temp_FoundItem(_Character);

QRY
LeaderLib_Growth_Items_QRY_HasAutoLevelItem((CHARACTERGUID)_Character)
AND
DB_LeaderLib_Growth_Items_Temp_FoundItem(_Character)
THEN
NOT DB_LeaderLib_Growth_Items_Temp_FoundItem(_Character);

IF
CharacterLeveledUp(_Character)
AND
LeaderLib_Growth_Items_QRY_HasAutoLevelItem(_Character)
THEN
LeaderLog_Log("TRACE", "[LeaderLib:Growth:Items:CharacterLeveledUp] Leveling up character equipment.");
SetStoryEvent(_Character, "LeaderLib_Events_AutoLevelItems_Start");

//Equipment doesn't work with `IterateItemsInInventory`
IF
StoryEvent((CHARACTERGUID)_Character, "LeaderLib_Events_AutoLevelItems_Start")
AND
DB_LeaderLib_EquipmentSlots(_Slot)
AND
CharacterGetEquippedItem(_Character, _Slot, (ITEMGUID)_Item)
AND
IsTagged(_Item, "LeaderLib_AutoLevel", 1)
THEN
CharacterItemSetEvent(_Character, _Item, "LeaderLib_Commands_CheckItemLevel");

IF
StoryEvent((ITEMGUID)_Item, "LeaderLib_Commands_AutoLevelItem")
AND
ItemGetOwner(_Item, _Character)
AND
NOT DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character)
AND
NOT GetVarInteger(_Item, "LeaderLib_Level", _)
AND
CharacterGetLevel(_Character, _Level)
THEN
DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character);
ItemLevelUpTo(_Item, _Level);
SetVarInteger(_Item, "LeaderLib_Level", _Level);
CharacterItemSetEvent(_Character, _Item, "LeaderLib_Events_ItemLeveledUp");

IF
StoryEvent((ITEMGUID)_Item, "LeaderLib_Commands_AutoLevelItem")
AND
ItemGetOwner(_Item, _Character)
AND
NOT DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character)
AND
GetVarInteger(_Item, "LeaderLib_Level", _ItemLevel)
AND
CharacterGetLevel(_Character, _Level)
AND
_ItemLevel < _Level
THEN
DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character);
ItemLevelUpTo(_Item, _Level);
SetVarInteger(_Item, "LeaderLib_Level", _Level);
CharacterItemSetEvent(_Character, _Item, "LeaderLib_Events_ItemLeveledUp");

IF
CharacterItemEvent(_Character, _Item, "LeaderLib_Commands_AutoLevelItem")
AND
NOT DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character)
AND
CharacterGetLevel(_Character, _Level)
THEN
DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character);
ItemLevelUpTo(_Item, _Level);
SetVarInteger(_Item, "LeaderLib_Level", _Level);
CharacterItemSetEvent(_Character, _Item, "LeaderLib_Events_ItemLeveledUp");

IF
ItemEquipped(_Item, _Character)
AND
IsTagged(_Item, "LeaderLib_AutoLevel", 1)
THEN
CharacterItemSetEvent(_Character, _Item, "LeaderLib_Commands_CheckItemLevel");

IF
DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character)
THEN
LeaderLib_StartCharacterItemTimer(_Character, _Item, 500, "LeaderLib_Timers_ResetAutoLeveledItemDatabase", "LeaderLib_Events_ResetAutoLeveledItemDatabase");

IF
CharacterItemEvent(_Character, _Item, "LeaderLib_Events_ResetAutoLeveledItemDatabase")
AND
DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character)
THEN
NOT DB_LeaderLib_Growth_Items_Temp_AutoLeveledItem(_Item, _Character);
//END_REGION

//REGION DELTA_MODS
QRY
LeaderLib_Growth_Items_QRY_Internal_TemplateMatch((ITEMGUID)_Item, (STRING)_Template)
AND
DB_LeaderLib_Growth_Items_TemplateID(_ID, _Template)
AND
DB_LeaderLib_Growth_Items_DeltaMods(_GroupID, _MinLevel, _DeltaMod, "ID", _ID)
AND
NOT DB_LeaderLib_Growth_Items_Temp_TemplateMatch(_Item, _Template)
THEN
DB_LeaderLib_Growth_Items_Temp_TemplateMatch(_Item, _Template);

QRY
LeaderLib_Growth_Items_QRY_Internal_TemplateMatch((ITEMGUID)_Item, (STRING)_Template)
AND
NOT DB_LeaderLib_Growth_Items_Temp_TemplateMatch(_Item, _Template)
AND
DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, "Template", _Template)
AND
NOT DB_LeaderLib_Growth_Items_Temp_TemplateMatch(_Item, _Template)
THEN
DB_LeaderLib_Growth_Items_Temp_TemplateMatch(_Item, _Template);

QRY
LeaderLib_Growth_Items_QRY_ItemHasDeltaMods((ITEMGUID)_Item)
AND
GetTemplate(_Item, _Template)
AND
LeaderLib_Growth_Items_QRY_Internal_TemplateMatch(_Item, _Template)
THEN
NOT DB_LeaderLib_Growth_Items_Temp_TemplateMatch(_Item, _Template);

QRY
LeaderLib_Growth_Items_QRY_ItemHasDeltaMods((ITEMGUID)_Item)
AND
DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, "Tag", _Tag)
AND
IsTagged(_Item, _Tag, 1)
THEN
DB_NOOP(1);

IF
CharacterItemEvent(_Character, _Item, "LeaderLib_Events_ItemLeveledUp")
AND
NOT DB_LeaderLib_Growth_Items_Temp_AppliedDeltaMods(_Character, _Item)
THEN
DB_LeaderLib_Growth_Items_Temp_AppliedDeltaMods(_Character, _Item);
LeaderLib_Growth_Items_ApplyDeltaMods(_Item);

IF
CharacterItemEvent(_Character, _Item, "LeaderLib_Events_ItemLevelCheckFinished")
AND
NOT DB_LeaderLib_Growth_Items_Temp_AppliedDeltaMods(_Character, _Item)
AND
LeaderLib_Growth_Items_QRY_ItemHasDeltaMods(_Item)
THEN
DB_LeaderLib_Growth_Items_Temp_AppliedDeltaMods(_Character, _Item);
LeaderLib_Growth_Items_ApplyDeltaMods(_Item);

IF
DB_LeaderLib_Growth_Items_Temp_AppliedDeltaMods(_Character, _Item)
THEN
LeaderLib_StartCharacterItemTimer(_Character, _Item, 500, "LeaderLib_Timers_Growth_ResetAppliedDeltaModsDatabase", "LeaderLib_Events_Growth_ResetAppliedDeltaModsDatabase");

IF
CharacterItemEvent(_Character, _Item, "LeaderLib_Events_Growth_ResetAppliedDeltaModsDatabase")
AND
DB_LeaderLib_Growth_Items_Temp_AppliedDeltaMods(_Character, _Item)
THEN
NOT DB_LeaderLib_Growth_Items_Temp_AppliedDeltaMods(_Character, _Item);

PROC
LeaderLib_Growth_Items_ApplyDeltaMods((ITEMGUID)_Item)
AND
GetVarInteger(_Item, "LeaderLib_Level", _ItemLevel)
AND
DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, "Tag", _Tag)
AND
IsTagged(_Item, _Tag, 1)
AND
_ItemLevel >= _MinLevel
//AND
//NOT LeaderLib_Helper_QRY_ItemHasDeltaModifier(_Item, _DeltaMod)
THEN
LeaderLog_Log("DEBUG", "[LeaderLib:Growth_Items:ApplyDeltaMods] Added deltamod [",_DeltaMod,"] to item.");
ItemAddDeltaModifier(_Item, _DeltaMod);

QRY
LeaderLib_Growth_Items_QRY_Internal_GetID((ITEMGUID)_Item)
AND
GetTemplate(_Item, _Template)
AND
DB_LeaderLib_Growth_Items_TemplateID(_ID, _Template)
THEN
DB_LeaderLib_Growth_Items_Temp_MatchedID(_Item, _ID);

PROC
LeaderLib_Growth_Items_ApplyDeltaMods((ITEMGUID)_Item)
AND
GetVarInteger(_Item, "LeaderLib_Level", _ItemLevel)
AND
LeaderLib_Growth_Items_QRY_Internal_GetID(_Item)
AND
DB_LeaderLib_Growth_Items_Temp_MatchedID(_Item, _ID)
AND
DB_LeaderLib_Growth_Items_DeltaMods(_GroupID, _MinLevel, _DeltaMod, "ID", _ID)
AND
_ItemLevel >= _MinLevel
//AND
//NOT LeaderLib_Helper_QRY_ItemHasDeltaModifier(_Item, _DeltaMod)
THEN
LeaderLog_Log("DEBUG", "[LeaderLib:Growth_Items:ApplyDeltaMods] Added deltamod [",_DeltaMod,"] to item via matched ID [",_ID,"].");
ItemAddDeltaModifier(_Item, _DeltaMod);

PROC
LeaderLib_Growth_Items_ApplyDeltaMods((ITEMGUID)_Item)
AND
DB_LeaderLib_Growth_Items_Temp_MatchedID(_Item, _ID)
THEN
NOT DB_LeaderLib_Growth_Items_Temp_MatchedID(_Item, _ID);

//Old template method
PROC
LeaderLib_Growth_Items_ApplyDeltaMods((ITEMGUID)_Item)
AND
GetVarInteger(_Item, "LeaderLib_Level", _ItemLevel)
AND
GetTemplate(_Item, _Template)
AND
DB_LeaderLib_Growth_Items_DeltaMods(_ID, _MinLevel, _DeltaMod, "Template", _Template)
AND
_ItemLevel >= _MinLevel
//AND
//NOT LeaderLib_Helper_QRY_ItemHasDeltaModifier(_Item, _DeltaMod)
THEN
LeaderLog_Log("DEBUG", "[LeaderLib:Growth_Items:ApplyDeltaMods] Added deltamod [",_DeltaMod,"] to item.");
ItemAddDeltaModifier(_Item, _DeltaMod);
//END_REGION

//REGION DELTAMOD_CHECK
PROC
LeaderLib_Growth_Items_CheckEquipmentForMissingDeltamods((CHARACTERGUID)_Character)
AND
DB_LeaderLib_EquipmentSlots(_Slot)
AND
CharacterGetEquippedItem(_Character, _Slot, (ITEMGUID)_Item)
AND
_Item != NULL_00000000-0000-0000-0000-000000000000
AND
LeaderLib_Growth_Items_QRY_ItemHasDeltaMods(_Item)
THEN
LeaderLib_Growth_Items_ApplyDeltaMods(_Item);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader__LeaderLib"
